<?php
/**
 * Created by PhpStorm.
 * User: laurent
 * Date: 31/10/18
 * Time: 11:37
 */

use Centreon\Test\Behat\CentreonContext;
use Centreon\Test\Behat\Configuration\HostConfigurationPage;
use Centreon\Test\Behat\Configuration\ServiceConfigurationPage;
use Centreon\Test\Behat\Configuration\CommentConfigurationPage;
use Centreon\Test\Behat\Configuration\CommentListingPage;

class VulnerabilityCommentContext extends CentreonContext
{
    const HOSTNAME = 'hostName';
    const SERVICE_DESCRIPTION = 'serviceDescription';
    protected $currentPage;
    protected $hostName = "hostname";

    protected $hostProperties = array(
        'name' => self::HOSTNAME,
        'alias' => 'hostAlias',
        'address' => 'host2@localhost'
    );

    protected $commentProperties = [
        'comment' => '<button>test</button>'
    ];

    protected $serviceProperties = array(
        'hosts' => self::HOSTNAME,
        'description' => self::SERVICE_DESCRIPTION,
        'templates' => 'generic-service',
        'check_command' => 'check_centreon_dummy',
        'check_period' => '24x7',
        'max_check_attempts' => 1,
        'normal_check_interval' => 1,
        'retry_check_interval' => 1,
        'active_checks_enabled' => 1,
        'passive_checks_enabled' => 0,
        'notifications_enabled' => 1,
        'notify_on_recovery' => 1,
        'notify_on_critical' => 1,
        'recovery_notification_delay' => 1,
        'cs' => 'admin_admin'
    );

    /**
     * @Given an host is configured
     */
    public function anHostIsConfigured()
    {
        $currentPage = new HostConfigurationPage($this);
        $currentPage->setProperties($this->hostProperties);
        $currentPage->save();
    }

    /**
     * @Given a service is configured
     */
    public function aServiceIsConfigured()
    {
        $currentPage = new ServiceConfigurationPage($this);
        $currentPage->setProperties($this->serviceProperties);
        $currentPage->save();
    }

    /**
     * @When I add a comment on service
     */
    public function iAddACommentOnService() {
        $this->reloadAllPollers();
        $currentPage = new CommentConfigurationPage(
            $this,
            self::HOSTNAME,
            self::SERVICE_DESCRIPTION
        );
        $currentPage->setProperties($this->commentProperties);
        $currentPage->save();
    }

    /**
     * @Then The html in comment is not interpreted
     */
    public function theHtmlInCommentIsNotInterpreted() {
        $this->spin(
            function($context) {
                $currentPage = new CommentListingPage($context, true);
                $comments = $currentPage->getEntries();
                var_dump($comments);
                return !empty($comments);
            },
            "",
            60
        );
    }
}